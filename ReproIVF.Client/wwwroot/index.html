<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>ReproIVF.Client</title>
    <base href="/" />
    <link href="css/app.css" rel="stylesheet" />
    <link href="manifest.json" rel="manifest" />

    <!-- If you add any scoped CSS files, uncomment the following to load them
    <link href="ReproIVF.Client.styles.css" rel="stylesheet" /> -->
</head>

<body>
    <div id="app">Loading...</div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">X</a>
    </div>

    <script>
        window.reproDownloadBase64File = (fileName, mimeType, base64) => {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            const blob = new Blob([bytes], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        window.reproPwa = (() => {
            let deferredPrompt = null;
            let dotnetRef = null;
            let initialized = false;

            const isIos = () => /iphone|ipad|ipod/i.test(navigator.userAgent);
            const isStandalone = () =>
                window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;

            const notifyStateChanged = () => {
                if (dotnetRef) {
                    dotnetRef.invokeMethodAsync("NotifyPwaStateChanged");
                }
            };

            const onBeforeInstallPrompt = (event) => {
                event.preventDefault();
                deferredPrompt = event;
                notifyStateChanged();
            };

            const onAppInstalled = () => {
                deferredPrompt = null;
                notifyStateChanged();
            };

            return {
                initialize: (dotnetObjectRef) => {
                    dotnetRef = dotnetObjectRef;
                    if (initialized) {
                        return;
                    }

                    window.addEventListener("beforeinstallprompt", onBeforeInstallPrompt);
                    window.addEventListener("appinstalled", onAppInstalled);
                    initialized = true;
                },
                dispose: () => {
                    window.removeEventListener("beforeinstallprompt", onBeforeInstallPrompt);
                    window.removeEventListener("appinstalled", onAppInstalled);
                    dotnetRef = null;
                    initialized = false;
                },
                getState: () => ({
                    isIos: isIos(),
                    isStandalone: isStandalone(),
                    canInstall: deferredPrompt !== null
                }),
                promptInstall: async () => {
                    if (!deferredPrompt) {
                        return false;
                    }

                    deferredPrompt.prompt();
                    const choice = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    notifyStateChanged();
                    return choice && choice.outcome === "accepted";
                }
            };
        })();
    </script>
    <script src="_framework/blazor.webassembly.js"></script>
    <script>navigator.serviceWorker.register('service-worker.js');</script>
</body>

</html>
