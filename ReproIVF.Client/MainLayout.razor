@inherits LayoutComponentBase
@implements IDisposable
@implements IAsyncDisposable
@inject AuthService Auth
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="layout">
    <aside class="sidebar">
        <div class="brand">
            <h2>ReproIVF</h2>
        </div>
        <nav>
            @if (!Auth.IsAuthenticated)
            {
                <a href="/login">Login</a>
            }
            else
            {
                <a href="/">Implants</a>

                @if (Auth.IsAdmin)
                {
                    <a href="/clients">Clients</a>
                    <a href="/donors">Donors</a>
                    <a href="/bulls">Bulls</a>
                    <a href="/technicians">Technicians</a>
                    <a href="/programs">Programs</a>
                    <a href="/semen-types">Semen Types</a>
                    <a href="/preservation-methods">Preservation Methods</a>
                    <a href="/users">Users</a>
                }

                <button type="button" class="nav-logout" @onclick="LogoutAsync">Logout (@Auth.Username)</button>
            }
        </nav>
    </aside>
    @if (ShowPwaBanner)
    {
        <div class="pwa-banner">
            @if (CanInstallPwa)
            {
                <span>Instala la app en tu telefono para acceso rapido.</span>
                <button type="button" class="pwa-install-btn" @onclick="InstallPwaAsync">Instalar app</button>
            }
            else if (IsIosDevice)
            {
                <span>iPhone/iPad: Safari > Compartir > Agregar a pantalla de inicio.</span>
            }
            <button type="button" class="pwa-dismiss-btn" aria-label="Ocultar" @onclick="DismissPwaBanner">X</button>
        </div>
    }
    <main>
        @Body
    </main>
</div>

@code {
    private DotNetObjectReference<MainLayout>? _dotNetRef;
    private bool _pwaBannerDismissed;
    private bool _pwaInitialized;
    private bool IsIosDevice { get; set; }
    private bool IsStandalone { get; set; }
    private bool CanInstallPwa { get; set; }
    private bool ShowPwaBanner => !_pwaBannerDismissed && !IsStandalone && (CanInstallPwa || IsIosDevice);

    protected override void OnInitialized()
    {
        Auth.Changed += HandleAuthChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _pwaInitialized)
        {
            return;
        }

        _dotNetRef = DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("reproPwa.initialize", _dotNetRef);
        await RefreshPwaStateAsync();
        _pwaInitialized = true;
        StateHasChanged();
    }

    public void Dispose()
    {
        Auth.Changed -= HandleAuthChanged;
    }

    public async ValueTask DisposeAsync()
    {
        if (_pwaInitialized)
        {
            await JS.InvokeVoidAsync("reproPwa.dispose");
        }

        _dotNetRef?.Dispose();
    }

    private async Task LogoutAsync()
    {
        await Auth.LogoutAsync();
        Nav.NavigateTo("/login", replace: true);
    }

    private void HandleAuthChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async Task NotifyPwaStateChanged()
    {
        await RefreshPwaStateAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task InstallPwaAsync()
    {
        var installed = await JS.InvokeAsync<bool>("reproPwa.promptInstall");
        if (installed)
        {
            _pwaBannerDismissed = true;
        }

        await RefreshPwaStateAsync();
    }

    private void DismissPwaBanner()
    {
        _pwaBannerDismissed = true;
    }

    private async Task RefreshPwaStateAsync()
    {
        var state = await JS.InvokeAsync<PwaInstallState>("reproPwa.getState");
        IsIosDevice = state.IsIos;
        IsStandalone = state.IsStandalone;
        CanInstallPwa = state.CanInstall;
    }

    private sealed class PwaInstallState
    {
        public bool IsIos { get; set; }
        public bool IsStandalone { get; set; }
        public bool CanInstall { get; set; }
    }
}
